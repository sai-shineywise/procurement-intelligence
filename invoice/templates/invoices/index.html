{% extends 'base.html' %}
{% block content %}
    <style>
        /* ... (other styles) ... */
        #result {
            margin-top: 20px;
        }

        .upload-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .upload-progress .spinner-border, .upload-progress span{
          display: none;
        }

        .remove-btn {
            display: inline-block;
        }

        .file-label {
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        #pdfFileInput{
            display:none;
        }

        .user-message, .model-response {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        .user-message {
            background-color: #dcf8c6;
            text-align: right;
            align-self: flex-end;
        }
        .model-response {
            background-color: #f0f0f0;
            text-align: left;
            align-self: flex-start;
        }
        .error-response{
           color: red;
        }

        #chatModal .modal-body {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 110px);
            overflow: hidden;
        }

        #chatbox {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
        }
          #chat-input-area {
            width: 100%;
        }
        #clear-history-btn{
          margin-left: 5px;
        }

        /* Loader CSS */
        .loader {
          width: 60px;
          aspect-ratio: 2;
          --_g: no-repeat radial-gradient(circle closest-side,#000 90%,#0000);
          background:
            var(--_g) 0%   50%,
            var(--_g) 50%  50%,
            var(--_g) 100% 50%;
          background-size: calc(100%/3) 50%;
          animation: l3 1s infinite linear;
        }
        @keyframes l3 {
            20%{background-position:0%   0%, 50%  50%,100%  50%}
            40%{background-position:0% 100%, 50%   0%,100%  50%}
            60%{background-position:0%  50%, 50% 100%,100%   0%}
            80%{background-position:0%  50%, 50%  50%,100% 100%}
        }
        /* Hide loader initially */
        #chat-loader {
            display: none;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 10;
        }

    </style>

    <!--  Include Showdown.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

<div class="container">
    <h1 class="mb-4">Procurement Intelligence</h1>

    <div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group">
                <label for="pdfFileInput" class="file-label">Choose File</label>
                <input type="file" class="form-control" id="pdfFileInput" accept=".pdf">
                 <span id="file-chosen" class="form-control-plaintext">No file chosen</span>
                <button id="addItemBtn" class="btn btn-primary" disabled>Add Item</button>
            </div>
            <div class="upload-progress mt-2">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Uploading...</span>
                </div>
                <span>Uploading...</span>
            </div>
        </div>
        <div class="col-md-6 text-end">
            <button id="processBtn" class="btn btn-success" disabled>Process Invoices</button>
        </div>
    </div>

    <h2 class="mt-4 mb-3">Uploaded Invoices:</h2>
    <table class="table">
        <thead>
        <tr>
            <th>Filename</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="invoiceTableBody">
        <!-- Table rows -->
        </tbody>
    </table>

    <div id="result" class="mt-4"></div>

       <button id="openChatBtn" class="btn btn-primary mt-3" style="display: none;" data-bs-toggle="modal" data-bs-target="#chatModal">
        Chat with Model
    </button>

    <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chatModalLabel">Chat with Model</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="chat-loader">
                        <div class="loader"></div>
                    </div>
                    <div id="chatbox" style="position: relative;"></div>
                    <div class="input-group mt-3" id="chat-input-area">
                        <input type="text" id="chat-input" class="form-control" placeholder="Ask a question...">
                        <button id="chat-submit" class="btn btn-primary">Send</button>
                        <button id="clear-history-btn" class="btn btn-secondary">Clear History</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        let filesData = [];
        let fileCount = 0;
        // Initialize Showdown converter
        const converter = new showdown.Converter();

        $('#pdfFileInput').on('change', function() {
          const fileName = $(this).val().split("\\").pop();
          $("#file-chosen").text(fileName);
          if (fileName) {
              $('#addItemBtn').prop('disabled', false);
            } else {
              $('#addItemBtn').prop('disabled', true);
            }
        });

        $('#addItemBtn').click(function () {
            const fileInput = $('#pdfFileInput')[0];
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const formData = new FormData();
                formData.append('file', file);

                $('.upload-progress .spinner-border').show();
                $('.upload-progress span').show();

                $.ajax({
                    url: '/upload/',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                         $('.upload-progress .spinner-border').hide();
                         $('.upload-progress span').hide();
                        if (data.success) {
                            filesData.push({ uri: data.uri, name: data.name, display_name: data.filename });
                           const rowIndex = fileCount++;

                            $('#invoiceTableBody').append(`
                                <tr id="invoiceRow-${rowIndex}">
                                    <td>${data.filename}</td>
                                    <td><button class="btn btn-danger btn-sm remove-btn" data-index="${rowIndex}">Remove</button></td>
                                </tr>
                            `);

                            $(`#invoiceTableBody`).off('click', '.remove-btn').on('click', '.remove-btn', function() {
                                 const index = parseInt($(this).data('index'), 10);
                                 $(`#invoiceRow-${index}`).remove();
                                 filesData = filesData.filter((_, i) => i !== index);
                                 fileCount = filesData.length;
                                  $('#invoiceTableBody tr').each(function(i) {
                                        $(this).attr('id', `invoiceRow-${i}`);
                                        $(this).find('button').attr('data-index', i);
                                  });
                                  updateProcessButtonState();
                            });

                            fileInput.value = '';
                            $('#addItemBtn').prop('disabled', true);
                            $("#file-chosen").text("No file chosen");
                            updateProcessButtonState();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    },
                    error: function () {
                         $('.upload-progress .spinner-border').hide();
                         $('.upload-progress span').hide();
                        alert('An error occurred during the upload.');
                    }
                });
            } else {
                alert('Please select a file.');
            }
        });

       $('#processBtn').click(function () {
            $('#result').html('<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>');
             $('#openChatBtn').hide();

            $.ajax({
                url: '/process/',
                type: 'POST',
                data: JSON.stringify({ files: filesData }),
                contentType: 'application/json',
                success: function (data) {
                    $('#result').empty();
                    if (data.success) {
                         if (data.result && data.result.lowest_vendor && data.result.lowest_vendor.name && data.result.lowest_vendor.price) {
                            $('#result').append('<h3 class="mt-3">Lowest Vendor</h3>');
                            var lowestVendorTable = $('<table class="table">');
                            var thead = $('<thead><tr><th scope="col">Vendor Name</th><th scope="col">Price</th></tr></thead>');
                            var tbody = $('<tbody>');
                            var row = $('<tr>');
                            row.append($('<td>').text(data.result.lowest_vendor.name));
                            row.append($('<td>').text(data.result.lowest_vendor.price));
                            tbody.append(row);
                            lowestVendorTable.append(thead, tbody);
                            $('#result').append(lowestVendorTable);
                        } else {
                           $('#result').append('<div class="alert alert-warning" role="alert">Could not determine the lowest vendor.</div>');
                        }

                       if (data.result && data.result.common_items && Array.isArray(data.result.common_items)) {
                            $('#result').append('<h3 class="mt-4">Common Items (Lowest Prices)</h3>');
                            var commonItemsTable = $('<table class="table">');
                            var thead = $('<thead><tr><th scope="col">Item Name</th><th scope="col">Price</th><th scope="col">Vendor</th><th scope="col">Appearance Count</th></tr></thead>');
                            var tbody = $('<tbody>');

                            data.result.common_items.forEach(function(item) {
                               var row = $('<tr>');
                               row.append($('<td>').text(item.item_name || 'N/A'));
                               row.append($('<td>').text(item.price || 'N/A'));
                               row.append($('<td>').text(item.vendor || 'N/A'));
                               row.append($('<td>').text(item.appearance_count || 'N/A'));
                               tbody.append(row);
                           });

                            commonItemsTable.append(thead, tbody);
                            $('#result').append(commonItemsTable);

                        } else {
                            $('#result').append('<div class="alert alert-warning" role="alert">No common items found.</div>');
                        }
                        $('#openChatBtn').show();
                    } else {
                        $('#result').html('<div class="alert alert-danger" role="alert">' + data.error + '</div>');
                    }
                },
                error: function () {
                    $('#result').html('<div class="alert alert-danger" role="alert">An error occurred during processing.</div>');
                }
            });
        });

        // Load chat history when modal opens
        $('#chatModal').on('show.bs.modal', function () {
            const chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            $('#chatbox').empty();  // Clear previous content

            // Convert Markdown to HTML and append to chatbox
            chatHistory.forEach(msg => {
                const messageClass = msg.role === 'You' ? 'user-message' : 'model-response';
                const contentHtml = msg.role === 'Model' ? converter.makeHtml(msg.content) : msg.content;
                $('#chatbox').append(`<div class="${messageClass}">${msg.role}: ${contentHtml}</div>`);
            });
             $('#chatbox').scrollTop($('#chatbox')[0].scrollHeight);
        });


        function showChatLoader() {
            $('#chat-loader').css('display', 'flex');
        }

        function hideChatLoader() {
            $('#chat-loader').hide();
        }


        // Chat functionality (inside the modal)
        $('#chat-submit').click(function () {
            const message = $('#chat-input').val();
            if (message.trim() === '') return;

            // No need to add user message here, it's handled on history load

            $('#chat-input').val('');
            showChatLoader();

            $.ajax({
                url: '/chat/',
                type: 'POST',
                data: JSON.stringify({ message: message }),
                contentType: 'application/json',
                success: function (data) {
                    hideChatLoader();
                    if (data.success) {
                       $('#chatbox').empty();

                        // Convert Markdown to HTML *on display*
                        data.history.forEach(msg => {
                            const messageClass = msg.role === 'You' ? 'user-message' : 'model-response';
                            const contentHtml = msg.role === 'Model' ? converter.makeHtml(msg.content) : msg.content; // Convert here
                            $('#chatbox').append(`<div class="${messageClass}">${msg.role}: ${contentHtml}</div>`);
                        });

                         localStorage.setItem('chatHistory', JSON.stringify(data.history));
                    } else {
                        $('#chatbox').append(`<div class="error-response">Error: ${data.error}</div>`);
                    }
                    $('#chatbox').scrollTop($('#chatbox')[0].scrollHeight);
                },
                error: function () {
                    hideChatLoader();
                    $('#chatbox').append('<div class="error-response">An error occurred during chat.</div>');
                    $('#chatbox').scrollTop($('#chatbox')[0].scrollHeight);
                }
            });
        });


        $('#clear-history-btn').click(function() {
            $.ajax({
                url: '/clear_chat_history/',
                type: 'POST',
                contentType: 'application/json',
                success: function(data) {
                    if (data.success) {
                        $('#chatbox').empty();
                        localStorage.removeItem('chatHistory');
                    } else {
                        alert('Failed to clear chat history.');
                    }
                },
                error: function() {
                    alert('An error occurred while clearing chat history.');
                }
            });
        });

        function updateProcessButtonState() {
            $('#processBtn').prop('disabled', filesData.length === 0);
        }

        $('#chat-input').keypress(function (e) {
            if (e.which == 13) {
                e.preventDefault();
                $('#chat-submit').click();
            }
        });
    });
</script>
{% endblock %}